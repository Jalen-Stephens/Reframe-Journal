# GitHub Actions CI Pipeline for Reframe Journal iOS App

name: iOS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: ReframeJournal
  PROJECT_PATH: ReframeJournal.xcodeproj
  COVERAGE_THRESHOLD: 25

jobs:
  build:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix Xcode project format
        run: |
          sed -i '' 's/objectVersion = 77;/objectVersion = 54;/' ReframeJournal.xcodeproj/project.pbxproj 2>/dev/null || true
          sed -i '' 's/preferredProjectObjectVersion = 77;/preferredProjectObjectVersion = 54;/' ReframeJournal.xcodeproj/project.pbxproj 2>/dev/null || true

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Resolve packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project $PROJECT_PATH \
            -scheme $SCHEME

      - name: Build
        run: |
          xcodebuild build-for-testing \
            -project $PROJECT_PATH \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.5" \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      - name: Test
        run: |
          xcodebuild test-without-building \
            -project $PROJECT_PATH \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.5" \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color

      - name: Check Coverage
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json
          
          python3 << 'EOF'
          import json
          import sys
          
          # Testable file patterns (match by filename anywhere in path)
          TESTABLE_PATTERNS = [
              'AIReframeDepth.swift',
              'AIReframeResult.swift',
              'EmotionItem.swift',
              'ReframeResponse.swift',
              'Thought.swift',
              'ThoughtEntry.swift',
              'ThoughtRecord.swift',
              'ValuesCategory.swift',
              'ValuesProfile.swift',
              'AdaptivePrompts.swift',
              'Color+Hex.swift',
              'DateUtils.swift',
              'Identifiers.swift',
              'Metrics.swift',
              'SuggestionEngine.swift',
              'ValuesChecklist.swift',
              'LimitsManager.swift',
              'ThoughtUsageService.swift',
          ]
          
          # Exclude patterns (SwiftData, network, ads, UI)
          EXCLUDE_PATTERNS = [
              'JournalEntry.swift',
              'ValuesProfileData.swift',
              'OpenAIClient.swift',
              'AIReframeService.swift',
              'RewardedAdManager',
              'EntitlementsManager.swift',
              'KeyboardDismiss.swift',
              '/Views/',
              '/UI/',
          ]
          
          with open('coverage.json') as f:
              data = json.load(f)
          
          total = covered = 0
          matched_files = []
          
          for target in data.get('targets', []):
              if 'ReframeJournal.app' not in target.get('name', ''):
                  continue
              for file_data in target.get('files', []):
                  path = file_data.get('path', '')
                  
                  # Skip excluded files
                  if any(excl in path for excl in EXCLUDE_PATTERNS):
                      continue
                  
                  # Check if file matches testable pattern
                  matches = any(pattern in path for pattern in TESTABLE_PATTERNS)
                  if not matches:
                      continue
                  
                  file_total = file_data.get('executableLines', 0)
                  file_covered = file_data.get('coveredLines', 0)
                  total += file_total
                  covered += file_covered
                  
                  if file_total > 0:
                      filename = path.split('/')[-1] if '/' in path else path
                      matched_files.append((filename, file_covered, file_total))
          
          pct = (covered / total * 100) if total > 0 else 0
          threshold = ${{ env.COVERAGE_THRESHOLD }}
          
          print(f"Matched {len(matched_files)} testable files")
          if matched_files:
              print("\nFile breakdown:")
              for name, cov, tot in sorted(matched_files, key=lambda x: x[2], reverse=True)[:10]:
                  print(f"  {name}: {cov}/{tot} lines ({cov/tot*100:.1f}%)" if tot > 0 else f"  {name}: {cov}/{tot} lines")
          
          print(f"\nTestable Coverage: {pct:.1f}% ({covered}/{total} lines)")
          print(f"Threshold: {threshold}%")
          
          if total == 0:
              print("⚠️ No testable files found in coverage report - check file paths")
              sys.exit(0)  # Don't fail if no files matched
          
          if pct < threshold:
              print(f"❌ Coverage {pct:.1f}% is below {threshold}%")
              sys.exit(1)
          print(f"✅ Coverage meets threshold")
          EOF

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7
