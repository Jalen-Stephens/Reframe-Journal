# GitHub Actions CI Pipeline for Reframe Journal iOS App
# Builds, tests, and enforces 80% code coverage threshold

name: iOS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: ReframeJournal
  PROJECT_PATH: ReframeJournal.xcodeproj
  SIMULATOR_NAME: iPhone 15
  SIMULATOR_OS: "17.5"
  COVERAGE_THRESHOLD: 80

jobs:
  test:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          # Use Xcode 15.4 for better iOS 17 compatibility
          sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          xcodebuild -version
          xcrun simctl list devices available

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -clonedSourcePackagesDirPath SourcePackages

      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR_NAME }},OS=${{ env.SIMULATOR_OS }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath SourcePackages \
            CODE_SIGNING_ALLOWED=NO \
            SKIP_INSTALL=YES \
            BUILD_LIBRARY_FOR_DISTRIBUTION=NO \
            | xcpretty --color

      - name: Run unit tests with coverage
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR_NAME }},OS=${{ env.SIMULATOR_OS }}" \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color --report junit --output test-results.xml

      - name: Extract and validate code coverage
        id: coverage
        run: |
          echo "=== Extracting Code Coverage ==="
          
          XCRESULT_PATH="TestResults.xcresult"
          
          if [ ! -d "$XCRESULT_PATH" ]; then
            echo "::error::Test results not found at $XCRESULT_PATH"
            exit 1
          fi
          
          # Generate JSON coverage report
          xcrun xccov view --report --json "$XCRESULT_PATH" > coverage.json
          
          # Extract coverage using Python script
          cat > extract_coverage.py << 'EOF'
          import json
          import sys
          
          with open('coverage.json', 'r') as f:
              data = json.load(f)
          
          for target in data.get('targets', []):
              if 'ReframeJournal.app' in target.get('name', ''):
                  line_cov = target.get('lineCoverage', 0)
                  if isinstance(line_cov, (int, float)):
                      print(f'{line_cov * 100:.2f}')
                      sys.exit(0)
          
          print('0.00')
          EOF
          
          COVERAGE_PERCENT=$(python3 extract_coverage.py)
          
          echo "Line Coverage: ${COVERAGE_PERCENT}%"
          echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          
          # Print detailed coverage report
          echo ""
          echo "=== Coverage Summary ==="
          xcrun xccov view --report "$XCRESULT_PATH" | head -50
          
          # Check threshold
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          
          echo ""
          echo "=== Coverage Threshold Check ==="
          echo "Current Coverage: ${COVERAGE_PERCENT}%"
          echo "Required Threshold: ${THRESHOLD}%"
          
          PASS=$(python3 -c "print('true' if float('${COVERAGE_PERCENT}') >= float('${THRESHOLD}') else 'false')")
          
          if [ "$PASS" = "false" ]; then
            echo ""
            echo "::error::Code coverage ${COVERAGE_PERCENT}% is below the required threshold of ${THRESHOLD}%"
            echo ""
            echo "To fix this:"
            echo "1. Add more unit tests for uncovered code paths"
            echo "2. Focus on testing business logic in Services/, ViewModels/, and Utilities/"
            echo "3. Run 'xcodebuild test' locally to see coverage details"
            exit 1
          else
            echo ""
            echo "Code coverage ${COVERAGE_PERCENT}% meets the required threshold of ${THRESHOLD}%"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-results.xml
            coverage.json
          retention-days: 14

      - name: Post coverage summary
        if: always()
        run: |
          COVERAGE="${{ steps.coverage.outputs.coverage_percent }}"
          THRESHOLD="${{ env.COVERAGE_THRESHOLD }}"
          
          if [ -n "$COVERAGE" ]; then
            echo "## Code Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Line Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Required Threshold | ${THRESHOLD}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            PASS=$(python3 -c "print('true' if float('${COVERAGE}') >= float('${THRESHOLD}') else 'false')")
            if [ "$PASS" = "true" ]; then
              echo "Coverage meets requirements" >> $GITHUB_STEP_SUMMARY
            else
              echo "Coverage below threshold - please add more tests" >> $GITHUB_STEP_SUMMARY
            fi
          fi
