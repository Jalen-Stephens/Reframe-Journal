# GitHub Actions CI Pipeline for Reframe Journal iOS App
# Builds, tests, and enforces 80% code coverage threshold

name: iOS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: ReframeJournal
  PROJECT_PATH: Reframe-Journal/ReframeJournal.xcodeproj
  SIMULATOR_NAME: iPhone 15
  SIMULATOR_OS: "17.2"
  COVERAGE_THRESHOLD: 80

jobs:
  test:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          # Use latest stable Xcode on the runner
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version
          xcrun simctl list devices available

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve Swift packages
        working-directory: Reframe-Journal
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ReframeJournal.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -clonedSourcePackagesDirPath SourcePackages

      - name: Build for testing
        working-directory: Reframe-Journal
        run: |
          set -o pipefail
          
          xcodebuild build-for-testing \
            -project ReframeJournal.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR_NAME }},OS=${{ env.SIMULATOR_OS }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath SourcePackages \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      - name: Run unit tests with coverage
        working-directory: Reframe-Journal
        run: |
          set -o pipefail
          
          xcodebuild test-without-building \
            -project ReframeJournal.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR_NAME }},OS=${{ env.SIMULATOR_OS }}" \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color --report junit --output test-results.xml

      - name: Extract and validate code coverage
        id: coverage
        working-directory: Reframe-Journal
        run: |
          echo "=== Extracting Code Coverage ==="
          
          # Find the coverage data file
          XCRESULT_PATH="TestResults.xcresult"
          
          if [ ! -d "$XCRESULT_PATH" ]; then
            echo "::error::Test results not found at $XCRESULT_PATH"
            exit 1
          fi
          
          # Generate JSON coverage report
          xcrun xccov view --report --json "$XCRESULT_PATH" > coverage.json
          
          # Extract coverage for the main target (ReframeJournal.app)
          # Using jq to parse the JSON and calculate line coverage
          COVERAGE_PERCENT=$(cat coverage.json | python3 -c "
          import json
          import sys
          
          data = json.load(sys.stdin)
          
          # Find the ReframeJournal target
          total_lines = 0
          covered_lines = 0
          
          for target in data.get('targets', []):
              # Only count the main app target, not test targets
              if 'ReframeJournal.app' in target.get('name', ''):
                  for file in target.get('files', []):
                      total_lines += file.get('lineCoverage', {}).get('count', 0) if isinstance(file.get('lineCoverage'), dict) else 0
                      covered_lines += file.get('lineCoverage', {}).get('covered', 0) if isinstance(file.get('lineCoverage'), dict) else 0
                      
                      # Alternative structure (flat lineCoverage as percentage)
                      if 'lineCoverage' in file and isinstance(file['lineCoverage'], (int, float)):
                          # This is already a percentage, we need to handle differently
                          pass
                  
                  # Use target-level coverage if available
                  line_cov = target.get('lineCoverage', 0)
                  if isinstance(line_cov, (int, float)):
                      print(f'{line_cov * 100:.2f}')
                      sys.exit(0)
          
          # Fallback: calculate from totals if per-file data was found
          if total_lines > 0:
              print(f'{(covered_lines / total_lines) * 100:.2f}')
          else:
              # Try simpler approach - just get overall coverage
              print('0.00')
          ")
          
          echo "Line Coverage: ${COVERAGE_PERCENT}%"
          echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          
          # Print detailed coverage report
          echo ""
          echo "=== Coverage Summary ==="
          xcrun xccov view --report "$XCRESULT_PATH" | head -50
          
          # Check threshold
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          PASS=$(python3 -c "print('true' if float('${COVERAGE_PERCENT}') >= float('${THRESHOLD}') else 'false')")
          
          echo ""
          echo "=== Coverage Threshold Check ==="
          echo "Current Coverage: ${COVERAGE_PERCENT}%"
          echo "Required Threshold: ${THRESHOLD}%"
          
          if [ "$PASS" = "false" ]; then
            echo ""
            echo "::error::âŒ Code coverage ${COVERAGE_PERCENT}% is below the required threshold of ${THRESHOLD}%"
            echo ""
            echo "To fix this:"
            echo "1. Add more unit tests for uncovered code paths"
            echo "2. Focus on testing business logic in Services/, ViewModels/, and Utilities/"
            echo "3. Run 'xcodebuild test' locally to see coverage details"
            exit 1
          else
            echo ""
            echo "âœ… Code coverage ${COVERAGE_PERCENT}% meets the required threshold of ${THRESHOLD}%"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            Reframe-Journal/TestResults.xcresult
            Reframe-Journal/test-results.xml
            Reframe-Journal/coverage.json
          retention-days: 14

      - name: Post coverage summary
        if: always()
        run: |
          COVERAGE="${{ steps.coverage.outputs.coverage_percent }}"
          THRESHOLD="${{ env.COVERAGE_THRESHOLD }}"
          
          if [ -n "$COVERAGE" ]; then
            echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Line Coverage | ${COVERAGE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Required Threshold | ${THRESHOLD}% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            PASS=$(python3 -c "print('true' if float('${COVERAGE}') >= float('${THRESHOLD}') else 'false')")
            if [ "$PASS" = "true" ]; then
              echo "âœ… **Coverage meets requirements**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Coverage below threshold - please add more tests**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
