# GitHub Actions CI Pipeline for Reframe Journal iOS App

name: iOS Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: ReframeJournal
  PROJECT_PATH: ReframeJournal.xcodeproj
  COVERAGE_THRESHOLD: 25

jobs:
  build:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix Xcode project format
        run: |
          sed -i '' 's/objectVersion = 77;/objectVersion = 54;/' ReframeJournal.xcodeproj/project.pbxproj 2>/dev/null || true
          sed -i '' 's/preferredProjectObjectVersion = 77;/preferredProjectObjectVersion = 54;/' ReframeJournal.xcodeproj/project.pbxproj 2>/dev/null || true

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Resolve packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project $PROJECT_PATH \
            -scheme $SCHEME

      - name: Build
        run: |
          xcodebuild build-for-testing \
            -project $PROJECT_PATH \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.5" \
            -derivedDataPath DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      - name: Test
        run: |
          xcodebuild test-without-building \
            -project $PROJECT_PATH \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.5" \
            -derivedDataPath DerivedData \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color

      - name: Check Coverage
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json
          
          python3 << 'EOF'
          import json
          import sys
          
          # Only count pure logic files that can be unit tested without mocking frameworks
          # Exclude: Views, UI, SwiftData models, network clients, ad managers, StoreKit
          TESTABLE_FILES = [
              # Models (pure data structs)
              'AIReframeDepth.swift',
              'AIReframeResult.swift', 
              'EmotionItem.swift',
              'ReframeResponse.swift',
              'Thought.swift',
              'ThoughtEntry.swift',
              'ThoughtRecord.swift',
              'ValuesCategory.swift',
              'ValuesProfile.swift',
              # Utilities (pure functions)
              'AdaptivePrompts.swift',
              'Color+Hex.swift',
              'DateUtils.swift',
              'Identifiers.swift',
              'Metrics.swift',
              'SuggestionEngine.swift',
              'ValuesChecklist.swift',
              # Services (with injectable dependencies)
              'LimitsManager.swift',
              'ThoughtUsageService.swift',
          ]
          
          with open('coverage.json') as f:
              data = json.load(f)
          
          total = covered = 0
          for target in data.get('targets', []):
              if 'ReframeJournal.app' not in target.get('name', ''):
                  continue
              for file_data in target.get('files', []):
                  path = file_data.get('path', '')
                  filename = path.split('/')[-1] if '/' in path else path
                  if filename not in TESTABLE_FILES:
                      continue
                  total += file_data.get('executableLines', 0)
                  covered += file_data.get('coveredLines', 0)
          
          pct = (covered / total * 100) if total > 0 else 0
          threshold = ${{ env.COVERAGE_THRESHOLD }}
          
          print(f"Testable Coverage: {pct:.1f}% ({covered}/{total} lines)")
          print(f"Threshold: {threshold}%")
          
          if pct < threshold:
              print(f"❌ Coverage {pct:.1f}% is below {threshold}%")
              sys.exit(1)
          print(f"✅ Coverage meets threshold")
          EOF

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.xcresult
          retention-days: 7
